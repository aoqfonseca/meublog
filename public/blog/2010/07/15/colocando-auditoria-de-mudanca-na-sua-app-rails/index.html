
<!DOCTYPE HTML>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Meu Blog, by Andre Fonseca</title>

  <meta name="author" content="Andre Fonseca">
  
  <meta name="description" content="Colocando Auditoria De MudanÃ§a Na Sua App Rails Jul 15th, 2010 Bom no meu projeto atual estou usando Ruby on Rails. Estou adorando. A coisa é &hellip;">
  
  

  <link rel="canonical" href="http://andrefonseca.net/blog/2010/07/15/colocando-auditoria-de-mudanca-na-sua-app-rails">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Meu Blog, by Andre Fonseca" type="application/atom+xml">
</head>
  
<body class="default">
  <div id="wrapper">
    <div id="header">
  <h1><a href="/">Meu Blog, by Andre Fonseca</a></h1>
  
    <p>Pensamentos, opiniões e alguns estudos</p>
  
</div>
<ul id="social-links">
  
    <li><a class="feed" href="/atom.xml" title="RSS">RSS</a></li>
  
  
    <li><a class="twitter" href="http://twitter.com/aoqfonseca" title="Twitter">Twitter</a></li>
  
  
    <li> <a class="github" href="https://github.com/aoqfonseca" title="GitHub">GitHub</a> </li>
  
</ul>
<div class="clear"></div>
<ul id="nav">
  
    <li> <a href="/">blog</a> </li>
  

  
    <li><a href="/blog/archives">archives</a></li>
  
</ul>

    <div id="main"> <div class="post-header">
  
    <h1 class="post-title">Colocando Auditoria De MudanÃ§a Na Sua App Rails</h1>
  
  








  


<time datetime="2010-07-15T00:00:00-03:00" pubdate data-updated="true">Jul 15<span>th</span>, 2010</time>
</div>

<div class="post-content">Bom no meu projeto atual estou usando Ruby on Rails. Estou adorando. A coisa é realmente fantástica e me sinto obrigado a dizer que é a melhor opção para desenvolver produtos web.  Mas não é por isso que resolvi escrever este post. Quero compartilhar um aprendizado adquirido.

Dentro da nossa aplicação precisamos mapear (auditoria) as alterações que são feitas em um determinado objeto.  Seria registrar no banco de dados quais campos alterados e, além disso, registra também qual era o valor antes e depois da alteração. Vamos a um exemplo.  Imaginemos que tenho um usuario; esse usuário tem nome, telefone e endereço. Ao alterar o nome dele, quero que fique resgistrado que seu nome foi alterado de um valor &#8220;A&#8221; para um valor &#8220;B&#8221;.

Ficando claro a necessidades vamos para a solução.  Passei então para procurar algum plugin que me ajudasse nessa missão. Encontrei vários.  &#8221;Acts_as_audited&#8221;,  foi um dos mais interessante que encontrei e recomendo se seu modelo for simples sem relacionamentos muito para muitos.  Mas apesar do plugin resolver o problema, fiquei intrigado de como seria possível fazer isso. Imaginei soluções das mais mirabolantes. Desde de criação de metodos proxies, a magias negras de alta classe (desculpem a brincadeira rubistas) .

Oque achei, como tudo no Ruby, foi a coisa mais simples e fácil já vista. Desde a versão 2.0 do rails, as classes active records ganharam alguns métodos que ajudam bastante nessa missão. São eles: changed?, changes, &lt;atributo&gt;_changed?, &lt;atributo&gt;_was, etc.

changed?  : ele indica se houve ou não alteração nos atributos do objeto. (false se não e true se sim)

changes : devolver um dicionario com as alterações que ocorreram. A chave dele é a propriedade e o valor é uma tupla com o valor antigo e o novo valor

&lt;atributo&gt;_changed? : é um metodo que diz se o atributo mudou. Algo como : usuario.nome_changed?

&lt;atributo&gt;_was : mostra o valor antigo do atributo

&lt;atributo&gt;_will_change! : meio que força a flag indicando que houve uma alteração.

Com esses métodos na mão é possível, sem ajuda do plugin fazer você mesmo sua funcionalidade de auditoria do sistema de forma bastante maneira.  Basta além deles usar os triggers before e after (create, update, etc) do model para chamar os métodos que farão a mágica acontecer.

Espero que ajude. Para saber mais, veja o screencast:<a href="http://media.railscasts.com/ipod_videos/109_tracking_attribute_changes.m4v"> tracking_attribute_changes.m4v</a>

Abraços e até a próxima
</div>


<div class="post-single">
  <div class="post-meta">
    


    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://andrefonseca.net/blog/2010/07/15/colocando-auditoria-de-mudanca-na-sua-app-rails/" data-via="aoqfonseca" data-counturl="http://andrefonseca.net/blog/2010/07/15/colocando-auditoria-de-mudanca-na-sua-app-rails/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
  </div>
  <div class="clear"></div>

  
</div>
 </div>
    <div id="footer">
  <div class="panels">
    <div class="license">
      <h2>License</h2>
      <p>Blog sob licença creative common. Autor: Andre Fonseca <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">clique aqui</a></p>
    </div>

    <div class="posts">
      <h2>Recent Posts</h2>
      <ul>
        
          <li>
            <a href="/blog/2012/04/13/bibliotecas-javascript/">Bibliotecas para Javascript</a>
          </li>
        
          <li>
            <a href="/blog/2012/03/04/onde-buscar/">Não precisa saber tudo mas o onde buscar sim.</a>
          </li>
        
          <li>
            <a href="/blog/2012/02/29/como-ver-a-ultima-tag-que-foi-criada-no-git/">Como ver a última tag que foi criada no git</a>
          </li>
        
          <li>
            <a href="/blog/2012/02/22/cada-um-tem-que-saber-seu-papel-e-sua-responsabilidade/">Cada um tem que saber seu papel e sua responsabilidade.</a>
          </li>
        
          <li>
            <a href="/blog/2011/11/25/customizando-a-renderizacao-do-template-de-form-do-admin-do-django/">Customizando a renderizaÃ§Ã£o do template de form do admin do Django</a>
          </li>
        
      </ul>
    </div>

    <div class="douban">
      <h2>Reading</h2>
      
        <p>Please set your Douban ID in _config.yml</p>
      
    </div>
  </div>

  <p class="powered">
    Powered by <a href="http://octopress.org">Octopress</a> and <a href="https://github.com/iwinux/compbits">Compbits</a>
  </p>
</div>

  </div> <!-- #wrapper end -->

  

  

<script type="text/javascript">
      var disqus_shortname = 'blogandrefonseca';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


  

  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>
